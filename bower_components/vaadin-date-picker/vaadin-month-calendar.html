<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
--><link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="vaadin-date-picker-helper.html">
<link rel="import" href="../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="vaadin-date-picker-styles.html">

<dom-module id="vaadin-month-calendar">
  <template>
    <style>
      :host {
        display: block;
      }

      [part="weekdays"],
      #days {
        display: flex;
        flex-wrap: wrap;
        flex-grow: 1;
      }

      #days-container,
      #weekdays-container {
        display: flex;
      }

      [part="week-numbers"] {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        flex-shrink: 0;
      }

      [part="week-numbers"][hidden],
      [part="weekday"][hidden] {
        display: none;
      }

      [part="weekday"],
      [part="date"] {
        /* Would use calc(100% / 7) but it doesn't work nice on IE */
        width: 14.285714286%;
      }

      [part="weekday"]:empty,
      [part="week-numbers"] {
        width: 12.5%;
        flex-shrink: 0;
      }
    </style>

    <div part="month-header" role="heading">[[_getTitle(month, i18n.monthNames)]]</div>
    <div id="monthGrid" on-tap="_handleTap" on-touchend="_preventDefault" on-touchstart="_onMonthGridTouchStart">
      <div id="weekdays-container">
        <div hidden="[[!_showWeekSeparator(showWeekNumbers, i18n.firstDayOfWeek)]]" part="weekday"></div>
        <div part="weekdays">
          <template is="dom-repeat" items="[[_getWeekDayNames(i18n.weekdays, i18n.weekdaysShort, showWeekNumbers, i18n.firstDayOfWeek)]]">
            <div part="weekday" role="heading" aria-label$="[[item.weekDay]]">[[item.weekDayShort]]</div>
          </template>
        </div>
      </div>
      <div id="days-container">
        <div part="week-numbers" hidden="[[!_showWeekSeparator(showWeekNumbers, i18n.firstDayOfWeek)]]">
          <template is="dom-repeat" items="[[_getWeekNumbers(_days)]]">
            <div part="week-number" role="heading" aria-label$="[[i18n.week]] [[item]]">[[item]]</div>
          </template>
        </div>
        <div id="days">
          <template is="dom-repeat" items="[[_days]]">
            <div part="date" today$="[[_isToday(item)]]" selected$="[[_dateEquals(item, selectedDate)]]" focused$="[[_dateEquals(item, focusedDate)]]" date="[[item]]" disabled$="[[!_dateAllowed(item, minDate, maxDate)]]" role$="[[_getRole(item)]]" aria-label$="[[_getAriaLabel(item)]]" aria-disabled$="[[_getAriaDisabled(item, minDate, maxDate)]]">[[_getDate(item)]]</div>
          </template>
        </div>
      </div>
    </div>
  </template>
  <script>
{
  var MonthCalendarElement = function (_Vaadin$ThemableMixin) {
    babelHelpers.inherits(MonthCalendarElement, _Vaadin$ThemableMixin);

    function MonthCalendarElement() {
      babelHelpers.classCallCheck(this, MonthCalendarElement);
      return babelHelpers.possibleConstructorReturn(this, (MonthCalendarElement.__proto__ || Object.getPrototypeOf(MonthCalendarElement)).apply(this, arguments));
    }

    babelHelpers.createClass(MonthCalendarElement, [{
      key: '_dateEquals',
      value: function _dateEquals(date1, date2) {
        return Vaadin.DatePickerHelper._dateEquals(date1, date2);
      }
    }, {
      key: '_dateAllowed',
      value: function _dateAllowed(date, min, max) {
        return Vaadin.DatePickerHelper._dateAllowed(date, min, max);
      }

      /* Returns true if all the dates in the month are out of the allowed range */

    }, {
      key: '_isDisabled',
      value: function _isDisabled(month, minDate, maxDate) {
        // First day of the month
        var firstDate = new Date(0, 0);
        firstDate.setFullYear(month.getFullYear());
        firstDate.setMonth(month.getMonth());
        firstDate.setDate(1);

        // Last day of the month
        var lastDate = new Date(0, 0);
        lastDate.setFullYear(month.getFullYear());
        lastDate.setMonth(month.getMonth() + 1);
        lastDate.setDate(-1);

        return !this._dateAllowed(firstDate, minDate, maxDate) && !this._dateAllowed(lastDate, minDate, maxDate);
      }
    }, {
      key: '_getTitle',
      value: function _getTitle(month, monthNames) {
        if (month === undefined || monthNames === undefined) {
          return;
        }
        return this.i18n.formatTitle(monthNames[month.getMonth()], month.getFullYear());
      }
    }, {
      key: '_onMonthGridTouchStart',
      value: function _onMonthGridTouchStart() {
        var _this2 = this;

        this._notTapping = false;
        setTimeout(function () {
          return _this2._notTapping = true;
        }, 300);
      }
    }, {
      key: '_dateAdd',
      value: function _dateAdd(date, delta) {
        date.setDate(date.getDate() + delta);
      }
    }, {
      key: '_applyFirstDayOfWeek',
      value: function _applyFirstDayOfWeek(weekDayNames, firstDayOfWeek) {
        if (weekDayNames === undefined || firstDayOfWeek === undefined) {
          return;
        }

        return weekDayNames.slice(firstDayOfWeek).concat(weekDayNames.slice(0, firstDayOfWeek));
      }
    }, {
      key: '_getWeekDayNames',
      value: function _getWeekDayNames(weekDayNames, weekDayNamesShort, showWeekNumbers, firstDayOfWeek) {
        if (weekDayNames === undefined || weekDayNamesShort === undefined || showWeekNumbers === undefined || firstDayOfWeek === undefined) {
          return;
        }
        weekDayNames = this._applyFirstDayOfWeek(weekDayNames, firstDayOfWeek);
        weekDayNamesShort = this._applyFirstDayOfWeek(weekDayNamesShort, firstDayOfWeek);
        weekDayNames = weekDayNames.map(function (day, index) {
          return {
            weekDay: day,
            weekDayShort: weekDayNamesShort[index]
          };
        });

        return weekDayNames;
      }
    }, {
      key: '_getDate',
      value: function _getDate(date) {
        return date ? date.getDate() : '';
      }
    }, {
      key: '_showWeekNumbersChanged',
      value: function _showWeekNumbersChanged(showWeekNumbers, firstDayOfWeek) {
        if (showWeekNumbers && firstDayOfWeek === 1) {
          this.setAttribute('week-numbers', '');
        } else {
          this.removeAttribute('week-numbers');
        }
      }
    }, {
      key: '_showWeekSeparator',
      value: function _showWeekSeparator(showWeekNumbers, firstDayOfWeek) {
        // Currently only supported for locales that start the week on Monday.
        return showWeekNumbers && firstDayOfWeek === 1;
      }
    }, {
      key: '_isToday',
      value: function _isToday(date) {
        return this._dateEquals(new Date(), date);
      }
    }, {
      key: '_getDays',
      value: function _getDays(month, firstDayOfWeek) {
        if (month === undefined || firstDayOfWeek === undefined) {
          return;
        }
        // First day of the month (at midnight).
        var date = new Date(0, 0);
        date.setFullYear(month.getFullYear());
        date.setMonth(month.getMonth());
        date.setDate(1);

        // Rewind to first day of the week.
        while (date.getDay() !== firstDayOfWeek) {
          this._dateAdd(date, -1);
        }

        var days = [];
        var startMonth = date.getMonth();
        var targetMonth = month.getMonth();
        while (date.getMonth() === targetMonth || date.getMonth() === startMonth) {
          days.push(date.getMonth() === targetMonth ? new Date(date.getTime()) : null);

          // Advance to next day.
          this._dateAdd(date, 1);
        }
        return days;
      }
    }, {
      key: '_getWeekNumber',
      value: function _getWeekNumber(date, days) {
        if (date === undefined || days === undefined) {
          return;
        }

        if (!date) {
          // Get the first non-null date from the days array.
          date = days.reduce(function (acc, d) {
            return !acc && d ? d : acc;
          });
        }

        return Vaadin.DatePickerHelper._getISOWeekNumber(date);
      }
    }, {
      key: '_getWeekNumbers',
      value: function _getWeekNumbers(dates) {
        var _this3 = this;

        return dates.map(function (date) {
          return _this3._getWeekNumber(date, dates);
        }).filter(function (week, index, arr) {
          return arr.indexOf(week) === index;
        });
      }
    }, {
      key: '_handleTap',
      value: function _handleTap(e) {
        if (!this.ignoreTaps && !this._notTapping && e.target.date && !e.target.hasAttribute('disabled')) {
          this.selectedDate = e.target.date;
          this.dispatchEvent(new CustomEvent('date-tap', { bubbles: true, composed: true }));
        }
      }
    }, {
      key: '_preventDefault',
      value: function _preventDefault(e) {
        e.preventDefault();
      }
    }, {
      key: '_getRole',
      value: function _getRole(date) {
        return date ? 'button' : 'presentational';
      }
    }, {
      key: '_getAriaLabel',
      value: function _getAriaLabel(date) {
        if (!date) {
          return '';
        }

        var ariaLabel = this._getDate(date) + ' ' + this.i18n.monthNames[date.getMonth()] + ' ' + date.getFullYear() + ', ' + this.i18n.weekdays[date.getDay()];

        if (this._isToday(date)) {
          ariaLabel += ', ' + this.i18n.today;
        }

        return ariaLabel;
      }
    }, {
      key: '_getAriaDisabled',
      value: function _getAriaDisabled(date, min, max) {
        if (date === undefined || min === undefined || max === undefined) {
          return;
        }
        return this._dateAllowed(date, min, max) ? 'false' : 'true';
      }
    }], [{
      key: 'is',
      get: function get() {
        return 'vaadin-month-calendar';
      }
    }, {
      key: 'properties',
      get: function get() {
        return {
          /**
           * A `Date` object defining the month to be displayed. Only year and
           * month properties are actually used.
           */
          month: {
            type: Date,
            value: new Date()
          },

          /**
           * A `Date` object for the currently selected date.
           */
          selectedDate: {
            type: Date,
            notify: true
          },

          /**
           * A `Date` object for the currently focused date.
           */
          focusedDate: Date,

          showWeekNumbers: {
            type: Boolean,
            value: false
          },

          i18n: {
            type: Object
          },

          /**
           * Flag stating whether taps on the component should be ignored.
           */
          ignoreTaps: Boolean,

          _notTapping: Boolean,

          /**
           * The earliest date that can be selected. All earlier dates will be disabled.
           */
          minDate: {
            type: Date,
            value: null
          },

          /**
           * The latest date that can be selected. All later dates will be disabled.
           */
          maxDate: {
            type: Date,
            value: null
          },

          _days: {
            type: Array,
            computed: '_getDays(month, i18n.firstDayOfWeek, minDate, maxDate)'
          },

          disabled: {
            type: Boolean,
            reflectToAttribute: true,
            computed: '_isDisabled(month, minDate, maxDate)'
          }
        };
      }
    }, {
      key: 'observers',
      get: function get() {
        return ['_showWeekNumbersChanged(showWeekNumbers, i18n.firstDayOfWeek)'];
      }
    }]);
    return MonthCalendarElement;
  }(Vaadin.ThemableMixin(Polymer.GestureEventListeners(Polymer.Element)));

  customElements.define(MonthCalendarElement.is, MonthCalendarElement);

  /**
   * @namespace Vaadin
   */
  window.Vaadin = window.Vaadin || {};
  Vaadin.MonthCalendarElement = MonthCalendarElement;
}</script>
</dom-module>
